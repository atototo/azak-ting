# 주식 분석 프로세스 개편 프로젝트 브리프

**프로젝트명**: 주식 분석 시스템 리뉴얼 - 뉴스 의존성 제거 및 펀더멘털 분석 강화
**작성일**: 2025-11-17
**작성자**: Mary (Business Analyst)
**프로젝트 타입**: System Redesign

---

## 📋 Executive Summary

현재 주식 분석 시스템은 **뉴스 발생에 전적으로 의존**하여, 뉴스가 없는 종목은 사용자가 등록해도 분석이 전혀 이루어지지 않는 심각한 문제가 있습니다. 본 프로젝트는 이를 해결하기 위해:

1. **뉴스 의존도 제거**: KIS API를 통해 시장 데이터, 투자자 수급, 재무비율 등을 주기적으로 수집
2. **펀더멘털 분석 강화**: 성장성/수익성/안정성 지표 기반 분석 추가
3. **분석 트리거 개편**: 종목 등록 즉시 분석, 모든 활성 종목 정기 분석
4. **Priority 제거**: 복잡도 감소, is_active만 사용

이를 통해 **뉴스 없어도 풍부한 분석 제공** 및 **사용자 경험 개선**을 달성합니다.

---

## 🎯 프로젝트 목표

### Primary Goals
1. **뉴스 없는 종목도 분석 가능**: 신규 등록 종목 즉시 분석, 기존 종목 정기 분석
2. **펀더멘털 기반 분석 강화**: 재무비율 데이터 추가로 수익성/성장성/안정성 평가
3. **사용자 경험 개선**: 종목 등록 즉시 "추적 중인 종목"에 표시

### Secondary Goals
- Priority 시스템 단순화 (is_active만 사용)
- API 효율화 (스케줄러 기반 DB 저장, 리포트 생성 시 DB 조회만)
- 데이터 투명성 확보 (어떤 데이터 사용했는지 명시)

---

## 🔍 현재 문제점 분석

### 1. 뉴스 의존적 분석 트리거

**현상**:
```
종목 등록 → DB 저장 → 뉴스 대기 → (뉴스 없으면 분석 안 됨)
```

**문제**:
- 사용자가 종목 관리에서 종목 추가해도 뉴스 없으면 **"추적 중인 종목(43개)"에 나타나지 않음**
- Priority 1-2만 하루 3번 자동 리포트 생성 (10:00, 13:00, 15:45)
- Priority 3-5는 뉴스 발생 시에만 분석됨
- 뉴스가 적은 중소형주는 사실상 분석 불가능

**영향**:
- 사용자 불만 증가
- 시스템 활용도 저하
- 경쟁력 약화

---

### 2. 수집 데이터의 활용도 불명확

**현재 수집 중**:
- ✅ 뉴스 (Naver, Hankyung, Maeil) - 10분마다
- ✅ 공시 (DART) - 5분마다, Priority 1-2만
- ✅ Reddit - 10분마다
- ✅ 시장 데이터 (현재가, 호가, 1분봉) - 1~5분마다
- ✅ 투자자 수급 (외국인/기관) - 매일

**문제**:
- 뉴스/공시/Reddit 없으면 시장 데이터만으로는 **분석이 트리거되지 않음**
- 각 데이터 소스의 예측 기여도 미측정
- Reddit 데이터 실효성 검증 부재

---

### 3. Priority 시스템의 중복성

**현재 Priority 역할**:
```
Priority 1-2: 자동 리포트 생성 O, 공시 수집 O
Priority 3-5: 자동 리포트 생성 X, 공시 수집 X
```

**문제**:
- Priority는 사실상 "활성화/비활성화" 역할 중복
- 사용자 혼란 (우선순위 vs 활성화)
- 불필요한 복잡도

---

### 4. Fallback 정책 부재

**현재**:
```python
if article.stock_code:  # 뉴스에 stock_code가 있어야만
    self._run_prediction(...)  # 예측 실행
```

**문제**:
- 데이터 부족 시 가용 데이터로 분석하는 로직 없음
- 최소 기준선(baseline) 분석 정책 부재

---

## ✅ 제안 솔루션

### 1. 뉴스 독립적 분석 시스템

#### 신규 종목 등록 즉시 분석
```
종목 등록 (종목 관리 UI)
  ↓
DB 저장 (is_active=True)
  ↓
KIS API 즉시 조회 (1회만)
  - 현재가
  - 투자자 수급
  - 종목 기본정보
  - 재무비율 ⭐ NEW!
  ↓
DB 저장
  ↓
초기 분석 실행 (뉴스 없어도 가능!)
  ↓
"추적 중인 종목"에 즉시 표시 ✅
```

#### 정기 분석: 모든 활성 종목
```
하루 3번 (10:00, 13:00, 15:45)
  ↓
모든 활성 종목 (is_active=True) 조회
  - Priority 조건 제거!
  ↓
DB에서 데이터 조회 (API 호출 없음)
  ↓
리포트 생성 및 저장
```

---

### 2. 새로운 데이터 수집: 재무비율 + 상품기본정보

#### 추가 KIS API
1. **재무비율 API** (FHKST66430300) 🔥
   - 성장성: 매출 성장률, 영업이익 성장률, 순이익 성장률
   - 수익성: ROE, EPS, SPS, BPS
   - 안정성: 부채비율, 유보율
   - 수집 주기: 주 1회 (일요일 새벽 2시)

2. **상품기본조회 API** (CTPF1604R)
   - 상품명, 분류, 유형, 위험등급
   - 수집 주기: 주 1회 (일요일 새벽 1시)

#### 데이터 계층 전략
```
Tier 1 (필수, 스케줄러 수집 → DB 저장):
  ✅ 현재가 (5분마다)
  ✅ 호가 (5분마다)
  ✅ 투자자 수급 (매일)
  ✅ 종목 정보 (주 1회) ⭐ NEW!
  ✅ 재무비율 (주 1회) ⭐ NEW!

Tier 2 (중요, DB):
  ✅ 기술적 지표 (과거 데이터 기반 계산)

Tier 3 (선택, 있으면 추가):
  ⚠️ 뉴스
  ⚠️ 공시
  ⚠️ Reddit
```

**리포트 생성 시**: DB 조회만! (API 호출 없음, Rate Limit 무관)

---

### 3. Priority 제거

#### 변경 사항
```python
# 기존
class Stock:
    priority = Column(Integer, default=5)  # ❌ 제거
    is_active = Column(Boolean, default=True)

# 개편
class Stock:
    is_active = Column(Boolean, default=True)  # ✅ 이것만 사용
```

#### 새로운 로직
```python
# 스케줄 리포트 생성
active_stocks = db.query(Stock).filter(
    Stock.is_active == True  # Priority 조건 제거!
).all()

# 하루 3번 모든 활성 종목 분석
```

---

### 4. 적응형 분석 프롬프트

#### LLM 프롬프트에 데이터 가용성 명시
```python
prompt = f"""
# 주식 분석: {stock_code}

## 데이터 가용성 (신뢰도: {completeness*100:.0f}%)

✅ 현재가: {current_price}원 ({change_rate}%)
✅ 외국인 5일 순매수: {foreign_net_buy:+,}주
✅ 재무비율 (최근 결산):
   - 매출 성장률: {revenue_growth}%
   - ROE: {roe}%
   - 부채비율: {debt_ratio}%
✅ PER: {per}, PBR: {pbr}
❌ 뉴스: 최근 7일간 없음

**중요**:
- 뉴스가 없으므로 펀더멘털과 수급 중심으로 분석하세요
- 데이터 한계를 명시하세요
"""
```

#### 분석 결과에 메타데이터 포함
```json
{
  "overall_summary": "...",
  "fundamental_analysis": "...",
  "recommendation": "중립",
  "confidence_level": "medium",
  "data_sources_used": {
    "market_data": true,
    "investor_trading": true,
    "financial_ratios": true,
    "news": false
  },
  "limitations": [
    "최근 7일간 뉴스 없음",
    "분석은 펀더멘털과 수급 기반"
  ]
}
```

---

## 🏗️ 기술 구현 계획

### Phase 1: DB 마이그레이션
- [ ] Migration 1: Priority 제거 (모든 값 1로 설정)
- [ ] Migration 2: product_info 테이블 추가
- [ ] Migration 3: financial_ratios 테이블 추가

### Phase 2: KIS API 추가
- [ ] `kis_client.py`: `get_product_info()` 메서드 추가
- [ ] `kis_client.py`: `get_financial_ratios()` 메서드 추가

### Phase 3: 데이터 수집 스케줄러
- [ ] `kis_product_info_collector.py` 생성 (주 1회, 일요일 1시)
- [ ] `kis_financial_collector.py` 생성 (주 1회, 일요일 2시)
- [ ] `crawler_scheduler.py`: 스케줄 등록

### Phase 4: 분석 로직 개편
- [ ] `stock_management.py`: 종목 등록 시 즉시 분석 트리거 추가
- [ ] `stock_analysis_service.py`: DB 조회 기반 컨텍스트 빌드
- [ ] `investment_report.py`: 적응형 프롬프트 생성
- [ ] `crawler_scheduler.py`: Priority 조건 제거 (is_active만)

### Phase 5: 프론트엔드 수정
- [ ] 종목 관리 UI: Priority 드롭다운 제거
- [ ] 분석 리포트 UI: 데이터 소스 표시 추가

### Phase 6: 테스트 및 검증
- [ ] 신규 종목 등록 → 즉시 분석 확인
- [ ] 뉴스 없는 종목 정기 분석 확인
- [ ] 재무비율 데이터 수집 확인
- [ ] 성능 테스트 (50개 종목 리포트 생성 시간)

---

## 📊 성공 지표 (KPIs)

### 정량적 지표
1. **분석 커버리지**: 등록 종목 중 분석된 종목 비율
   - 현재: ~60% (뉴스 있는 종목만)
   - 목표: **100%** (모든 활성 종목)

2. **신규 종목 분석 시간**: 종목 등록 후 첫 분석까지 소요 시간
   - 현재: 뉴스 발생 시까지 (무한대)
   - 목표: **즉시** (< 1분)

3. **리포트 생성 빈도**: 종목당 하루 리포트 생성 횟수
   - 현재: Priority 1-2만 3회/일, 나머지 불규칙
   - 목표: **모든 종목 3회/일** (10:00, 13:00, 15:45)

4. **API 호출 최적화**: 리포트 생성 시 API 호출 수
   - 현재: 종목당 0~5회 (불규칙)
   - 목표: **0회** (DB 조회만)

### 정성적 지표
- 사용자 만족도 (종목 등록 후 즉시 분석 확인 가능)
- 분석 품질 (펀더멘털 데이터 추가로 심층 분석)
- 시스템 안정성 (Rate Limit 걱정 없음)

---

## ⚠️ 리스크 및 대응 방안

### Risk 1: 재무비율 API 오류 (모의투자 미지원)
- **영향**: 재무비율 데이터 수집 불가
- **대응**: 실전 계정 사용, 오류 시 graceful degradation (재무비율 없이 분석)

### Risk 2: DB 마이그레이션 실패
- **영향**: 시스템 다운타임
- **대응**:
  - 마이그레이션 전 DB 백업
  - downgrade() 함수 구현으로 롤백 가능
  - 개발 환경 선행 테스트

### Risk 3: 리포트 생성 시간 증가 (모든 종목 분석)
- **영향**: 스케줄러 지연
- **대응**:
  - 병렬 처리 (asyncio 활용)
  - 배치 처리 최적화
  - 타임아웃 설정

### Risk 4: Priority 제거로 인한 기존 코드 영향
- **영향**: Priority 참조 코드 오류
- **대응**:
  - 코드베이스 전체 검색 (`priority <= 2`)
  - 단계적 제거 (먼저 1로 설정, 이후 완전 제거)

---

## 📅 타임라인 (예상)

### Week 1: 설계 및 준비
- Day 1-2: PRD 작성 및 리뷰
- Day 3-4: DB 마이그레이션 파일 작성
- Day 5: 개발 환경 마이그레이션 테스트

### Week 2: 코어 개발
- Day 1-2: KIS API 추가 (재무비율, 상품정보)
- Day 3-4: 데이터 수집 스케줄러 구현
- Day 5: 분석 로직 개편 (즉시 분석, DB 조회)

### Week 3: 통합 및 테스트
- Day 1-2: 프론트엔드 수정 (Priority 제거)
- Day 3-4: 통합 테스트
- Day 5: 성능 테스트 및 최적화

### Week 4: 배포 및 모니터링
- Day 1: 스테이징 배포
- Day 2-3: QA 및 버그 수정
- Day 4: 프로덕션 배포
- Day 5: 모니터링 및 핫픽스

---

## 🔧 구현 체크리스트

### Backend
- [ ] DB 마이그레이션 (3개 파일)
- [ ] KIS API 메서드 추가 (2개)
- [ ] 데이터 수집 스케줄러 (2개)
- [ ] 분석 로직 개편 (4개 파일 수정)
- [ ] Priority 조건 제거 (코드베이스 전체)

### Frontend
- [ ] 종목 관리 UI (Priority 제거)
- [ ] 리포트 UI (데이터 소스 표시)

### DevOps
- [ ] DB 백업 스크립트
- [ ] 마이그레이션 롤백 플랜
- [ ] 모니터링 대시보드 (신규 테이블)

### Documentation
- [x] 프로젝트 브리프 (본 문서)
- [ ] API 명세서 업데이트
- [ ] DB 스키마 다이어그램
- [ ] 배포 가이드

---

## 📚 참고 자료

- KIS API 문서: 재무비율 [v1_국내주식-080]
- KIS API 문서: 상품기본조회 [v1_국내주식-029]
- 현재 시스템 분석 결과 (본 세션)
- 기존 코드베이스: `/Users/young/ai-work/azak/backend/`

---

## 👥 이해관계자

- **개발자**: 백엔드/프론트엔드 개발 및 배포
- **사용자**: 종목 등록 즉시 분석 확인, 뉴스 없어도 분석 가능
- **비즈니스**: 시스템 경쟁력 향상, 사용자 만족도 증가

---

## ✅ 승인 및 다음 단계

**승인 필요 사항**:
1. Priority 제거 방식 (완전 제거 vs 1로 고정)
2. 재무비율 데이터 수집 주기 (주 1회 vs 월 1회)
3. 리포트 생성 빈도 (현행 유지 vs 변경)

**다음 단계**:
1. 본 브리프 검토 및 승인
2. PRD 상세 작성 (필요 시)
3. DB 마이그레이션 파일 생성
4. 개발 착수

---

**문서 작성자**: Mary (Business Analyst)
**최종 수정일**: 2025-11-17
**버전**: 1.0
